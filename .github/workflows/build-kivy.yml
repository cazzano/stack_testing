name: Build Kivy Android APK (Working Docker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'cross_plateform'
        type: string

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cross_plateform branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || 'cross_plateform' }}
        path: source-code
    
    - name: Prepare build workspace
      run: |
        mkdir -p build-workspace
        cp -r source-code/python/kivy/* build-workspace/
        
        # Create buildozer.spec if missing
        if [ ! -f "build-workspace/buildozer.spec" ]; then
          cat > build-workspace/buildozer.spec << 'EOF'
        [app]
        title = My Simple Kivy App
        package.name = simplekivyapp
        package.domain = org.example
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 0.1
        requirements = python3,kivy==2.1.0,pillow
        orientation = portrait
        fullscreen = 0
        
        [buildozer]
        log_level = 2
        warn_on_root = 1
        
        [android]
        android.permissions = INTERNET
        android.api = 31
        android.minapi = 21
        android.ndk = 25b
        android.sdk = 31
        android.ndk_api = 21
        android.archs = arm64-v8a
        android.accept_sdk_license = True
        EOF
        fi
        
        ls -la build-workspace/
    
    # Try multiple working Docker images as fallback
    - name: Build APK with homdx/buildozer
      run: |
        docker run --rm \
          -v $(pwd)/build-workspace:/app \
          -w /app \
          homdx/buildozer \
          buildozer android debug || echo "homdx/buildozer failed, trying next option..."
    
    - name: Build APK with unsuitable001/buildozer3 (fallback)
      if: failure()
      run: |
        docker run --rm \
          -v $(pwd)/build-workspace:/buildozer \
          -w /buildozer \
          unsuitable001/buildozer3 \
          buildozer android debug
    
    - name: List generated files
      run: |
        echo "Build workspace contents:"
        find build-workspace -name "*.apk" || echo "No APK found"
        ls -la build-workspace/bin/ || echo "No bin directory"
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kivy-android-apk-${{ github.run_number }}
        path: build-workspace/bin/*.apk
        if-no-files-found: warn
