name: Build APK - Buildozer Action

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'cross_plateform'
        type: string

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || 'cross_plateform' }}
        path: source-code
    
    - name: Prepare build workspace
      run: |
        mkdir -p build-workspace
        cp -r source-code/python/kivy/* build-workspace/ 2>/dev/null || echo 'No kivy directory found, using root'
        
        # Create optimized buildozer.spec
        cat > build-workspace/buildozer.spec << 'EOF'
[app]
title = My Kivy App
package.name = kivyapp
package.domain = org.kivy
source.dir = .
source.include_exts = py,png,jpg,kv,atlas,txt,md
version = 0.1
requirements = python3,kivy==2.1.0,certifi
orientation = portrait
fullscreen = 0

[buildozer]
log_level = 2
warn_on_root = 0

[android]
android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
android.api = 33
android.minapi = 21
android.ndk = 25b
android.sdk = 33
android.ndk_api = 21
android.archs = arm64-v8a
android.accept_sdk_license = True
android.skip_update = False
android.gradle_dependencies = 
android.add_compile_options = 

# Auto-accept all Android SDK licenses
android.add_packaging_options = pickFirst **/libc++_shared.so, pickFirst **/libjsc.so
android.gradle_repositories = google(), mavenCentral()
EOF
        
        # Create a simple main.py if none exists
        if [ ! -f build-workspace/main.py ]; then
          cat > build-workspace/main.py << 'EOF'
from kivy.app import App
from kivy.uix.label import Label
from kivy.uix.boxlayout import BoxLayout
import platform

class KivyApp(App):
    def build(self):
        layout = BoxLayout(orientation='vertical', padding=20, spacing=20)
        
        title = Label(
            text='Hello from Kivy Buildozer!',
            font_size='24sp',
            size_hint_y=None,
            height='60dp'
        )
        
        info = Label(
            text=f'Built with: Kivy Buildozer Action\\nPython: {platform.python_version()}\\nArchitecture: {platform.machine()}',
            font_size='16sp',
            halign='center'
        )
        info.bind(size=info.setter('text_size'))
        
        layout.add_widget(title)
        layout.add_widget(info)
        return layout

if __name__ == '__main__':
    KivyApp().run()
EOF
        fi
        
        echo 'Build workspace prepared:'
        ls -la build-workspace/
    
    - name: Build Android APK
      uses: ArtemSBulgakov/buildozer-action@v1
      with:
        command: buildozer android debug
        buildozer_version: ==1.5.0
        workdir: build-workspace
    
    - name: Verify APK generation
      run: |
        cd build-workspace
        
        echo '=== APK Verification ==='
        APK_COUNT=$(find . -name '*.apk' -type f | wc -l)
        echo "Found $APK_COUNT APK file(s)"
        
        if [ $APK_COUNT -gt 0 ]; then
          echo 'APK Details:'
          find . -name '*.apk' -type f -exec ls -lh {} \;
          find . -name '*.apk' -type f -exec file {} \;
          echo 'âœ… Buildozer Action APK build successful!'
        else
          echo 'âŒ No APK files generated'
          echo 'Build directory contents:'
          find . -type f -name '*.log' -exec echo '=== {} ===' \; -exec tail -100 {} \; || echo 'No log files'
          ls -la bin/ 2>/dev/null || echo 'No bin directory'
          exit 1
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-action-apk-${{ github.run_number }}
        path: build-workspace/bin/*.apk
        retention-days: 30
        if-no-files-found: error
    
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-action-logs-${{ github.run_number }}
        path: |
          build-workspace/.buildozer/
          build-workspace/*.log
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Final build summary
      if: always()
      run: |
        echo "## ðŸš€ Buildozer Action Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Method:** ArtemSBulgakov/buildozer-action@v1" >> $GITHUB_STEP_SUMMARY
        echo "- **Buildozer Version:** 1.5.0" >> $GITHUB_STEP_SUMMARY
        echo "- **Source Branch:** ${{ github.event.inputs.branch || 'cross_plateform' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Container:** Official Kivy Buildozer Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        WORKSPACE_DIR=$(pwd)
        if find build-workspace -name '*.apk' -type f | grep -q .; then
          APK_SIZE=$(find build-workspace -name '*.apk' -type f -exec ls -lh {} \; | awk '{print $5}' | head -1)
          APK_NAME=$(find build-workspace -name '*.apk' -type f | head -1 | xargs basename)
          echo "- **Status:** âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Generated:** âœ… $APK_NAME (Size: $APK_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Download:** Available in artifacts section below" >> $GITHUB_STEP_SUMMARY
          echo "- **Powered by:** Buildozer Action ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Generated:** âŒ No" >> $GITHUB_STEP_SUMMARY
          echo "- **Action Required:** Check build logs in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Note:** Back to debugging we go ðŸ”§" >> $GITHUB_STEP_SUMMARY
        fi
